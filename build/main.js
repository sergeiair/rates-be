require("source-map-support/register"),module.exports=function(e){var t={};function r(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(s,a,function(t){return e[t]}.bind(null,a));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=16)}([function(e,t){e.exports=require("realm")},function(e,t){e.exports=require("koa-trie-router")},function(e,t){e.exports=require("koa-mount")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("ramda")},function(e,t){e.exports=require("md5")},function(e,t){e.exports=require("node-schedule")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("@tensorflow/tfjs-node")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("@koa/cors")},function(e,t){e.exports=require("koa-session-auth")},function(e,t){e.exports=require("koa")},function(e,t,r){"use strict";r.r(t);var s={port:3333},a={root:"./static",options:{}},i=r(7),n=r.n(i),o=r(8),c=r.n(o),l=r(1),u=r.n(l),d=r(2),p=r.n(d);function b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const h=r(9);class g{static error(e){try{this.logFile.write((e.stack.split(")")[0]||e.message)+" \n")}catch(e){console.error(e.message)}}}function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}b(g,"logFile",h.createWriteStream("./logger/files/log",{flags:"a"})),b(g,"logStdout",process.stdout);const f=r(10);class y{constructor(e){m(this,"isRunning",!1),m(this,"model",f.sequential()),m(this,"inputTnsr",null),m(this,"labelTnsr",null),m(this,"_data",[]),this.configure(),this.init(e)}getPrediction(e,t,r,s,a){return f.tidy(()=>{const i=f.tensor2d(e,[1,e.length]).sub(r).div(t.sub(r));return this.model.predict(i.reshape([1,e.length])).mul(a.sub(s)).add(s).dataSync()})}getNormalizedValues(){return f.tidy(()=>{const e=this.inputTnsr.max(),t=this.inputTnsr.min(),r=this.labelTnsr.max(),s=this.labelTnsr.min();return{inputs:this.inputTnsr.sub(t).div(e.sub(t)),labels:this.labelTnsr.sub(s).div(r.sub(s)),inputMax:e,inputMinVal:t,labelMax:r,labelMinVal:s}})}init(e){this._data=e||[],this.initTensors()}initTensors(){f.util.shuffle(this._data),this.initInputTnsr(),this.initLabelsTnsr()}initInputTnsr(){this.inputTnsr=f.tensor(this._data.map(e=>[e.volatility,e.forecast,e.realRate,e.predRate]))}initLabelsTnsr(){this.labelTnsr=f.tensor2d(this._data.map(e=>e.finalRate),[this._data.length,1])}configure(){this.model.add(f.layers.dense({units:1,inputShape:[4]})),this.model.add(f.layers.dense({units:1,useBias:!0})),this.model.compile({loss:"meanSquaredError",optimizer:"sgd"})}destroy(){this.model.dispose()}async getResult(e){const{inputMax:t,inputMinVal:r,labelMinVal:s,labelMax:a}=this.getNormalizedValues();return this.getPrediction(e,t,r,s,a)}trainModel(e,t){const{inputs:r,labels:s}=this.getNormalizedValues();return new Promise((a,i)=>{this.isRunning||(this.isRunning=!0,this.model.fit(r,s,{batchSize:t,epochs:e}).then(()=>{this.isRunning=!1,a("trainingDone")}))})}}function w(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function S(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?w(Object(r),!0).forEach((function(t){v(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):w(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function v(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const P={name:"Prediction",primaryKey:"id",properties:{id:"int",predRate:"double",realRate:"double",finalRate:"double",pair:"string",owner:"string",time:"int",verifyTime:"int",forecast:"int",volatility:"int"}};var O=r(0),j=r.n(O);function D(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function R(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?D(Object(r),!0).forEach((function(t){U(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):D(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function U(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var q=r(3);const N={name:"User",primaryKey:"email",properties:{id:"int",email:{type:"string",indexed:!0},name:"string",pw:"string",restoreToken:{type:"string",default:""},active:{type:"bool",default:!0}}};function T(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function x(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class C{constructor(){x(this,"_data",null),x(this,"_error",null),x(this,"_code",null)}set data(e){this.isObject(e)&&(this._data=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?T(Object(r),!0).forEach((function(t){x(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):T(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},e)),this._code=200}get data(){return this._data}set error(e){this._error=e,this._code=503}get code(){return this._code}set code(e){this._code=e}isObject(e){return!!e&&e.constructor===Object}}const k={name:"Session",primaryKey:"id",properties:{expired:"int",id:"string",info:"string"}};var F=r(5);function M(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class B{constructor(){M(this,"userConfig",{schema:[N],deleteRealmIfMigrationNeeded:!0,path:"./db/files/users/01.realm"}),M(this,"sessionConfig",{schema:[k],deleteRealmIfMigrationNeeded:!0,path:"./db/files/sessions/01.realm"})}getUserUnsafe(e){return j.a.open(this.userConfig).then(t=>t.objectForPrimaryKey("User",e)).catch(e=>g.error(e))}getSession(e){return j.a.open(this.sessionConfig).then(t=>t.objectForPrimaryKey("Session",e)).catch(e=>g.error(e))}async getUser(e){const t=new C,r=await this.getUserUnsafe(e.email);return r&&q.compareSync(e.pw||"",r.pw||"")?t.data={hashedEmail:F(r.email),email:r.email,name:r.name}:(t.error="Not found",t.code=404),t}storeSession(e,t){return j.a.open(this.sessionConfig).then(r=>{r.write(()=>{r.create("Session",{expired:Date.now()+Be.maxAge,id:e,info:t},j.a.UpdateMode.Modified)}),r.close()}).catch(e=>{g.error(e)})}destroySession(e){return j.a.open(this.sessionConfig).then(t=>{const r=t.objectForPrimaryKey("Session",e);r&&t.write(()=>{t.delete(r)}),t.close()}).catch(e=>{g.error(e)})}async getRestoreToken(e){return new Promise((t,r)=>{j.a.open(this.userConfig).then(r=>{const s=new C,a=r.objectForPrimaryKey("User",e);a&&!a.restoreToken?r.write(()=>{a.restoreToken=function(e){return q.hashSync(e+"_frvr3$R34gTgtr5_",5)}(e),s.data={token:a.restoreToken,name:a.name},t(s)}):(s.data={status:"started"},s.code=208,t(s)),r.close()}).catch(e=>{g.error(e),r(e.message)})})}registerUser(e){return j.a.open(this.userConfig).then(t=>{const{email:r,pw:s,name:a}=e,i=new C;return t.objects("User").filtered(`email = "${r}"`).isEmpty()?t.write(()=>{t.create("User",{id:t.objects("User").length+1,pw:q.hashSync(s,10),name:a||r.split("@")[0],email:r},j.a.UpdateMode.Never),i.data={email:r}}):(i.error="User already exists",i.code=200),t.close(),i}).catch(e=>{g.error(e)})}async createPw(e,t){return j.a.open(this.userConfig).then(r=>{const s=new C,a=r.objects("User").filtered(`restoreToken = "${t}" LIMIT(1)`);return a[0]?r.write(()=>{a[0].pw=q.hashSync(e,10),a[0].restoreToken="",s.data={status:"Done"}}):s.error="Failed",r.close(),s}).catch(e=>{g.error(e)})}}function E(e){return(e.session.user||"").split("$")[0]}const _=new class{constructor(e){var t,r,s;s=void 0,(r="dataService")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.dataService=e}getSession(e){return this.dataService.getSession(e)}}(new B),A=async(e,t)=>{if(e.session.isNew)e.data=null,e.status=401;else{const t=await _.getSession(E(e));(!t||t.expired<=Date.now())&&(e.data=null,e.status=401)}e.type="json",await t()};var H=r(4);function K(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function $(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?K(Object(r),!0).forEach((function(t){I(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):K(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function I(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const L=new(r(1)),G=new class{constructor(e){v(this,"tfsService",void 0),v(this,"dataService",void 0),this.dataService=e}getAll(e){return this.dataService.getAll(e)}storeSingle(e){this.dataService.storeSingle(this.getPreparedPredData(e))}getPreparedPredData(e){return S(S({},e),{},{volatility:this.getVolatilityByPair(e.volatility,e.pair)})}getVolatilityByPair(e,t){if(e)return e;switch(t){case"USD/CHF":return 1;case"USD/GBP":case"USD/EUR":return 2;case"USD/RUB":return 4;default:return 3}}async prepareTFService(e,t){const r=await this.dataService.getAllCompletedPredictions(t,e.pair);if(r&&r.length){const e=r.map(e=>({predRate:e.predRate,realRate:e.realRate,finalRate:e.finalRate,forecast:e.forecast,volatility:e.volatility}));return this.tfsService=void 0,this.tfsService=new y(e),await this.tfsService.trainModel(500,32)}return"empty"}getComputedPrediction(e){return this.tfsService.getResult([this.getVolatilityByPair(e.volatility,e.pair),e.forecast,e.realRate,e.predRate],500)}}(new class{constructor(){U(this,"config",{schema:[P],deleteRealmIfMigrationNeeded:!0,path:"./db/files/predictions/01.realm"})}getAll(e){return j.a.open(this.config).then(t=>t.objects("Prediction").filtered(`owner = "${e}"`).sorted("time",!0)).catch(e=>{g.error(e)})}storeSingle(e){j.a.open(this.config).then(t=>{t.write(()=>{t.create("Prediction",R(R({},e),{},{finalRate:0,verifyTime:0,id:Date.now()}),j.a.UpdateMode.Never)}),t.close()}).catch(e=>g.error(e))}getAllCompletedPredictions(e,t){return j.a.open(this.config).then(r=>r.objects("Prediction").filtered(`owner = "${e}" AND finalRate != 0 AND pair = "${t}"`)).catch(e=>{g.error(e)})}}),V=new u.a;var z=()=>(V.post((L.post("/",A,async(e,t)=>{try{G.storeSingle($($({},e.request.body),{},{owner:E(e)})),e.body={message:"Done!"}}catch(t){e.body={message:t.message}}await t()}),L.middleware())),V.post((L.post("/compute-current",A,async(e,t)=>{try{const t=await G.getComputedPrediction(e.request.body);e.body={message:"Done!",result:t}}catch(t){e.body={message:t.message}}await t()}),L.middleware())),V.post((L.post("/prepare-for-history",A,async(e,t)=>{try{const t=await G.prepareTFService(e.request.body,E(e));e.body={message:"Done!",status:t}}catch(t){e.body={message:t.message}}await t()}),L.middleware())),V.get((L.get("/",A,async(e,t)=>{try{const t=await G.getAll(E(e));e.body={message:"Done fetch!",predictions:Object(H.map)(Object(H.dissoc)("owner"),t)}}catch(t){e.body={message:t.message}}await t()}),L.middleware())),V.middleware());function J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class W{static set(e,t){this.latestBase=e,this.latestRates=t}static ratesHaveValue(){return!!this.latestRates&&!!Object.keys(this.latestRates).length}static isRequiredTimePassed(){return Date.now()-this.prevSet>this.requiredMsGap}static updatePrevRequestTime(){this.prevSet=Date.now()}static isNewValue(e,t){return this.latestBase!==e||this.latestRates.USDEUR.toString()!==t.USDEUR.toString()||this.latestRates.USDNOK.toString()!==t.USDNOK.toString()||this.latestRates.USDGBP.toString()!==t.USDGBP.toString()||this.latestRates.USDRUB.toString()!==t.USDRUB.toString()||this.latestRates.USDCHF.toString()!==t.USDCHF.toString()||this.latestRates.USDPLN.toString()!==t.USDPLN.toString()}}function X(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}J(W,"prevSet",Date.now()),J(W,"requiredMsGap",27e5),J(W,"latestBase",null),J(W,"latestRates",{USDEUR:0,USDNOK:0,USDGBP:0,USDRUB:0,USDCHF:0,USDPLN:0});const Y=r(11).default,Z=r(6);class Q{static start(e){this.job=this.instance.scheduleJob("*/45 * * * *",()=>this.requestData(e)),this.status=1}static stop(){this.instance.cancelJob(this.job),this.status=0}static dataFetched(e,t){}static requestData(e){W.isRequiredTimePassed()&&(W.updatePrevRequestTime(),console.log((new Date).toLocaleTimeString()),Y.get(this.endpoint+"&currency=USDEUR,USDPLN,USDNOK,USDGBP,USDCHF,USDRUB").then(t=>this.dataFetched(e,t.data)).catch(console.error))}}X(Q,"endpoint","https://fxmarketapi.com/apilive?api_key=WtgXjLLRpYZqNwOOXId0"),X(Q,"instance",Z),X(Q,"job",null),X(Q,"status",0);const ee={name:"Rate",primaryKey:"id",properties:{id:"int",base:{type:"string",indexed:!0},USD:"double",EUR:"double",NOK:"double",GBP:"double",RUB:"double",CHF:"double",PLN:"double",time:"string"}};function te(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const re=new(r(1)),se=new class{constructor(e){var t,r,s;s=void 0,(r="dataService")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.dataService=e,this.bindSchedulerService(),this.enable()}bindSchedulerService(){Q.dataFetched=this.dataFetched.bind(this)}enable(){Q.start("USD"),Q.requestData("USD")}getStatus(){return Q.status}dataFetched(e,t){this.isSaveAllowed(e,t.price||{})&&this.dataService.storeSingle(e,t.price||{}),this.updateStaticStore(e,t.price||{})}updateStaticStore(e,t){W.set(e,t)}isSaveAllowed(e,t){return W.isNewValue(e,t)}}(new class{constructor(){te(this,"validCurrencies",["USD","EUR","NOK","GBP","RUB","CHF","PLN"]),te(this,"config",{schema:[ee],deleteRealmIfMigrationNeeded:!0,path:"./db/files/rates/01.realm"})}storeSingle(e,t){j.a.open(this.config).then(r=>{r.write(()=>{r.create("Rate",{id:Date.now(),base:e,USD:1,EUR:parseFloat(t.USDEUR),NOK:parseFloat(t.USDNOK),GBP:parseFloat(t.USDGBP),RUB:parseFloat(t.USDRUB),CHF:parseFloat(t.USDCHF),PLN:parseFloat(t.USDPLN),time:(new Date).toISOString()},j.a.UpdateMode.Never)}),r.close()}).catch(e=>{g.error(e)})}}),ae=new u.a;var ie=()=>(ae.post((re.post("/enable",A,async(e,t)=>{try{se.enable(),e.body={message:"Done",status:await se.getStatus()}}catch(t){e.body={message:t.message}}await t()}),re.middleware())),ae.get((re.get("/status",A,async(e,t)=>{try{const t=await se.getStatus();e.body={message:"Done",status:t}}catch(t){e.body={message:t.message}}await t()}),re.middleware())),ae.middleware());function ne(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const oe=r(6);class ce{static start(e){this.job=this.instance.scheduleJob("*/30 * * * * *",()=>this.startPendingItemsReview(e)),this.status=1}static stop(){this.instance.cancelJob(this.job),this.status=0}static startPendingItemsReview(e){}}ne(ce,"instance",oe),ne(ce,"job",null),ne(ce,"status",0);const le=new(r(1)),ue=new class{constructor(e){var t,r,s;s=void 0,(r="dataService")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.dataService=e,this.bindSchedulerService(),this.enable()}enable(){ce.start("USD")}getStatus(){return ce.status}bindSchedulerService(){ce.startPendingItemsReview=this.fillPendingPredictions.bind(this)}fillPendingPredictions(){W.ratesHaveValue()&&this.dataService.fillPendingPredictions(W.latestRates)}}(new class{constructor(){var e,t,r;r={schema:[P],deleteRealmIfMigrationNeeded:!0,path:"./db/files/predictions/01.realm"},(t="config")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}fillPendingPredictions(e){return j.a.open(this.config).then(t=>{const r=Date.now(),s=t.objects("Prediction").filtered("finalRate = 0 AND time < "+r)||[];t.write(()=>{s.forEach(t=>{const s=t.pair.replace("/","");t.finalRate=parseFloat(e[s]),t.verifyTime=r})}),t.close()}).catch(e=>{g.error(e)})}}),de=new u.a;var pe=()=>(de.post((le.post("/enable",A,async(e,t)=>{try{ue.enable(),e.body={message:"Done",status:await ue.getStatus()}}catch(t){e.body={message:t.message}}await t()}),le.middleware())),de.get((le.get("/status",A,async(e,t)=>{try{const t=await ue.getStatus();e.body={message:"Done",status:t}}catch(t){e.body={message:t.message}}await t()}),le.middleware())),de.middleware());function be(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const he=new(r(1)),ge=new class{constructor(e){var t,r,s;s=void 0,(r="dataService")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.dataService=e}getPair(e,t){return this.dataService.getPair(e)}getHistory(e,t){return this.dataService.getHistory(e,t)}}(new class{constructor(){be(this,"validCurrencies",["USD","EUR","NOK","GBP","RUB","CHF","PLN"]),be(this,"config",{schema:[ee],deleteRealmIfMigrationNeeded:!0,path:"./db/files/rates/01.realm"})}getPair(e){return j.a.open(this.config).then(t=>t.objects("Rate").filtered(`base = "${e}"`).sorted("id",!0).slice(0,1)).catch(e=>{g.error(e)})}getHistory(e,t){return j.a.open(this.config).then(r=>r.objects("Rate").filtered(`base = "${e}"`).slice(0,t)).catch(e=>{g.error(e)})}}),me=new u.a;var fe=()=>(me.get((he.get("/pair",A,async(e,t)=>{try{const{base:t,second:r}=e.request.query,s=await ge.getPair(t,r);e.body={message:"Done",rates:s}}catch(t){e.body={message:t.message}}await t()}),he.middleware())),me.get((he.get("/history",A,async(e,t)=>{try{const{base:t,limit:r}=e.request.query,s=await ge.getHistory(t,r);e.body={message:"Done",rates:s}}catch(t){e.body={message:t.message}}await t()}),he.middleware())),me.middleware());const ye=r(12);class we{static sendPwReset(e,t){return this.emailTransporter.sendMail({from:'"Rates pal" <noreply@ratespal.com>',to:e,subject:"Reset password",text:"",html:t})}}var Se,ve,Pe;Se=we,ve="emailTransporter",Pe=ye.createTransport({host:"smtp.gmail.com",port:465,service:"gmail",secure:!1,auth:{user:"ratespalmail@gmail.com",pass:"rer9Ohdgmail"},debug:!1,logger:!0}),ve in Se?Object.defineProperty(Se,ve,{value:Pe,enumerable:!0,configurable:!0,writable:!0}):Se[ve]=Pe;const Oe=new(r(1)),je=new class{constructor(e){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"dataService",void 0),this.dataService=e}register(e){return this.dataService.registerUser(e)}getUser(e){return this.dataService.getUser(e)}storeSession(e,t){return this.dataService.storeSession(e,t)}destroySession(e){return this.dataService.destroySession(e)}async initRestore(e){const t=await this.dataService.getRestoreToken(e);var r,s;return t.data.token&&we.sendPwReset(e,(r=t.data.name,s=t.data.token,`\n        Hi ${r}, <br>\n        Need to reset your password? Click on the link below to get you in.  <br>\n        <a href="http://localhost:4000/reset-password?v=${s}">Create new password</a>\n    `)),t}createPw(e,t){return this.dataService.createPw(e,t)}}(new B),De=async(e,t)=>{e.type="json",e.set("Access-Control-Expose-Headers","GoAway"),await t()},Re=new u.a;var Ue=()=>(Re.post((Oe.post("/register",De,async(e,t)=>{try{const t=await je.register(e.request.body);e.status=t.code,e.body={message:"Done",resp:t}}catch(t){e.status=500,e.body={message:t.message}}await t()}),Oe.middleware())),Re.post((Oe.post("/login",De,async(e,t)=>{try{const t=await je.getUser(e.request.body);t.data?(je.storeSession(t.data.hashedEmail,e.request.headers.referer),e.session.user=`${t.data.hashedEmail}$${Date.now()}`,e.body={message:"Done",data:{email:t.data.email,name:t.data.name}}):e.body={message:"Not found",data:{}},e.status=t.code}catch(t){e.status=500,e.body={message:t.message}}await t()}),Oe.middleware())),Re.post((Oe.post("/logout",De,async(e,t)=>{try{je.destroySession(E(e)),e.status=200,e.body={message:"Done"}}catch(t){e.status=500,e.body={message:t.message}}await t()}),Oe.middleware())),Re.post((Oe.post("/restore",De,async(e,t)=>{try{const t=await je.initRestore(e.request.body.user);e.status=t.code,e.body={message:"Done"}}catch(t){e.status=500,e.body={message:t.message}}await t()}),Oe.middleware())),Re.post((Oe.post("/create-pw",De,async(e,t)=>{try{const t=await je.createPw(e.request.body.pw,e.request.body.v);e.status=t.code,e.body={message:"Done",data:t}}catch(t){e.status=500,e.body={message:t.message}}await t()}),Oe.middleware())),Re.middleware());function qe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ne=new(r(1)),Te=new class{constructor(e,t){qe(this,"tfsService",void 0),qe(this,"dataService",void 0),this.dataService=e,this.tfsService=t}getAllCompletedPredictions(e,t){return this.dataService.getAllCompletedPredictions(e,t)}}(new class{constructor(){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"config",{schema:[P],deleteRealmIfMigrationNeeded:!0,path:"./db/files/predictions/01.realm"})}getAllCompletedPredictions(e,t){return j.a.open(this.config).then(r=>r.objects("Prediction").filtered(`owner = "${e}" AND finalRate != 0 AND time >= ${t.dateStart} AND time <= ${t.dateEnd}`).sorted("time",!0)).catch(e=>{g.error(e)})}},new y),xe=new u.a;var Ce=()=>(xe.post((Ne.post("/completed",A,async(e,t)=>{try{const t=await Te.getAllCompletedPredictions(E(e),e.request.body);e.body={message:"Done",data:Object(H.map)(Object(H.dissoc)("owner"),t)}}catch(t){e.body={message:t.message}}await t()}),Ne.middleware())),xe.middleware());const ke=new u.a;r(13);const Fe=r(2),Me=r(14),Be={useToken:!0,useCookie:!1,key:"GoAway",maxAge:864e5,autoCommit:!0,overwrite:!0,httpOnly:!0,signed:!0,rolling:!1,renew:!1,genid:e=>g.warn(e)};const Ee=new(r(15)),_e=process.env.HOST||"127.0.0.1",Ae=process.env.PORT||s.port;var He;(He=Ee).use(async(e,t)=>{try{await t(),404===e.status&&e.throw(404),401===e.status&&e.throw(401),200===e.status&&(e.body={status:200,data:e.body})}catch(t){g.error(t),e.status=t.status||500,e.type="json",e.body={status:e.status,message:t.message},e.app.emit("error",t,e)}}),He.keys=["11223344qqwweerr"],He.use(c()()),He.use(n()(a.root)),He.use(Me(Be,He)),He.use(Fe("/api",(ke.use(p()("/predictions",z())),ke.use(p()("/rates-scheduler",ie())),ke.use(p()("/predictions-scheduler",pe())),ke.use(p()("/rates",fe())),ke.use(p()("/users",Ue())),ke.use(p()("/analyze",Ce())),ke.middleware()))),He.on("error",e=>{g.error(e.message)}),Ee.listen(Ae,_e)}]);
//# sourceMappingURL=main.map