require("source-map-support/register"),module.exports=function(e){var t={};function r(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(s,a,function(t){return e[t]}.bind(null,a));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=16)}([function(e,t){e.exports=require("realm")},function(e,t){e.exports=require("koa-trie-router")},function(e,t){e.exports=require("koa-mount")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("ramda")},function(e,t){e.exports=require("md5")},function(e,t){e.exports=require("node-schedule")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("bunyan")},function(e,t){e.exports=require("@tensorflow/tfjs-node")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("@koa/cors")},function(e,t){e.exports=require("koa-session-auth")},function(e,t){e.exports=require("koa")},function(e,t,r){"use strict";r.r(t);var s={port:3333},a={root:"./static",options:{}},i=r(7),n=r.n(i),o=r(8),c=r.n(o),l=r(1),d=r.n(l),u=r(2),p=r.n(u);const g=r(9).createLogger({name:"app",level:"debug",path:"./log.json"});function b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const h=r(10);class m{constructor(e){b(this,"isRunning",!1),b(this,"model",h.sequential()),b(this,"inputTnsr",null),b(this,"labelTnsr",null),b(this,"_data",[]),this.configure(),this.init(e)}getPrediction(e,t,r,s,a){return h.tidy(()=>{const i=h.tensor2d(e,[1,e.length]).sub(r).div(t.sub(r));return this.model.predict(i.reshape([1,e.length])).mul(a.sub(s)).add(s).dataSync()})}getNormalizedValues(){return h.tidy(()=>{const e=this.inputTnsr.max(),t=this.inputTnsr.min(),r=this.labelTnsr.max(),s=this.labelTnsr.min();return{inputs:this.inputTnsr.sub(t).div(e.sub(t)),labels:this.labelTnsr.sub(s).div(r.sub(s)),inputMax:e,inputMinVal:t,labelMax:r,labelMinVal:s}})}init(e){this._data=e||[],this.initTensors()}initTensors(){h.util.shuffle(this._data),this.initInputTnsr(),this.initLabelsTnsr()}initInputTnsr(){this.inputTnsr=h.tensor(this._data.map(e=>[e.volatility,e.forecast,e.realRate,e.predRate]))}initLabelsTnsr(){this.labelTnsr=h.tensor2d(this._data.map(e=>e.finalRate),[this._data.length,1])}configure(){this.model.add(h.layers.dense({units:1,inputShape:[4]})),this.model.add(h.layers.dense({units:1,useBias:!0})),this.model.compile({loss:"meanSquaredError",optimizer:"sgd"})}destroy(){this.model.dispose()}async getResult(e){const{inputMax:t,inputMinVal:r,labelMinVal:s,labelMax:a}=this.getNormalizedValues();return this.getPrediction(e,t,r,s,a)}trainModel(e,t){const{inputs:r,labels:s}=this.getNormalizedValues();return new Promise((a,i)=>{this.isRunning||(this.isRunning=!0,this.model.fit(r,s,{batchSize:t,epochs:e}).then(()=>{this.isRunning=!1,a("trainingDone")}))})}}function f(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?f(Object(r),!0).forEach((function(t){w(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const S={name:"Prediction",primaryKey:"id",properties:{id:"int",predRate:"double",realRate:"double",finalRate:"double",pair:"string",owner:"string",time:"int",verifyTime:"int",forecast:"int",volatility:"int"}};var v=r(0),P=r.n(v);function O(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function j(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?O(Object(r),!0).forEach((function(t){D(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):O(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function D(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var R=r(3);const U={name:"User",primaryKey:"email",properties:{id:"int",email:{type:"string",indexed:!0},name:"string",pw:"string",restoreToken:{type:"string",default:""},active:{type:"bool",default:!0}}};function q(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function N(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class T{constructor(){N(this,"_data",null),N(this,"_error",null),N(this,"_code",null)}set data(e){this.isObject(e)&&(this._data=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?q(Object(r),!0).forEach((function(t){N(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):q(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},e)),this._code=200}get data(){return this._data}set error(e){this._error=e,this._code=503}get code(){return this._code}set code(e){this._code=e}isObject(e){return!!e&&e.constructor===Object}}const x={name:"Session",primaryKey:"id",properties:{expired:"int",id:"string",info:"string"}};var C=r(5);function k(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class M{constructor(){k(this,"userConfig",{schema:[U],deleteRealmIfMigrationNeeded:!0,path:"./db/files/users/01.realm"}),k(this,"sessionConfig",{schema:[x],deleteRealmIfMigrationNeeded:!0,path:"./db/files/sessions/01.realm"})}getUserUnsafe(e){return P.a.open(this.userConfig).then(t=>t.objectForPrimaryKey("User",e)).catch(e=>g.error(e.message))}getSession(e){return P.a.open(this.sessionConfig).then(t=>t.objectForPrimaryKey("Session",e)).catch(e=>g.error(e.message))}async getUser(e){const t=new T,r=await this.getUserUnsafe(e.email);return r&&R.compareSync(e.pw||"",r.pw||"")?t.data={hashedEmail:C(r.email),email:r.email,name:r.name}:(t.error="Not found",t.code=404),t}storeSession(e,t){return P.a.open(this.sessionConfig).then(r=>{r.write(()=>{r.create("Session",{expired:Date.now()+Me.maxAge,id:e,info:t},P.a.UpdateMode.Modified)}),r.close()}).catch(e=>{g.error(e.message)})}destroySession(e){return P.a.open(this.sessionConfig).then(t=>{const r=t.objectForPrimaryKey("Session",e);r&&t.write(()=>{t.delete(r)}),t.close()}).catch(e=>{g.error(e.message)})}async getRestoreToken(e){return new Promise((t,r)=>{P.a.open(this.userConfig).then(r=>{const s=new T,a=r.objectForPrimaryKey("User",e);a&&!a.restoreToken?r.write(()=>{a.restoreToken=function(e){return R.hashSync(e+"_frvr3$R34gTgtr5_",5)}(e),s.data={token:a.restoreToken,name:a.name},t(s)}):(s.data={status:"started"},s.code=208,t(s)),r.close()}).catch(e=>{g.error(e.message),r(e.message)})})}registerUser(e){return P.a.open(this.userConfig).then(t=>{const{email:r,pw:s,name:a}=e,i=new T;return t.objects("User").filtered(`email = "${r}"`).isEmpty()?t.write(()=>{t.create("User",{id:t.objects("User").length+1,pw:R.hashSync(s,10),name:a||r.split("@")[0],email:r},P.a.UpdateMode.Never),i.data={email:r}}):(i.error="User already exists",i.code=200),t.close(),i}).catch(e=>{g.error(e.message)})}async createPw(e,t){return P.a.open(this.userConfig).then(r=>{const s=new T,a=r.objects("User").filtered(`restoreToken = "${t}" LIMIT(1)`);return a[0]?r.write(()=>{a[0].pw=R.hashSync(e,10),a[0].restoreToken="",s.data={status:"Done"}}):s.error="Failed",r.close(),s}).catch(e=>{g.error(e.message)})}}function F(e){return(e.session.user||"").split("$")[0]}const B=new class{constructor(e){var t,r,s;s=void 0,(r="dataService")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.dataService=e}getSession(e){return this.dataService.getSession(e)}}(new M),E=async(e,t)=>{if(e.session.isNew)e.data=null,e.status=401;else{const t=await B.getSession(F(e));(!t||t.expired<=Date.now())&&(e.data=null,e.status=401)}e.type="json",await t()};var _=r(4);function A(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function H(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?A(Object(r),!0).forEach((function(t){K(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):A(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function K(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const $=new(r(1)),I=new class{constructor(e){w(this,"tfsService",void 0),w(this,"dataService",void 0),this.dataService=e}getAll(e){return this.dataService.getAll(e)}storeSingle(e){this.dataService.storeSingle(this.getPreparedPredData(e))}getPreparedPredData(e){return y(y({},e),{},{volatility:this.getVolatilityByPair(e.volatility,e.pair)})}getVolatilityByPair(e,t){if(e)return e;switch(t){case"USD/CHF":return 1;case"USD/GBP":case"USD/EUR":return 2;case"USD/RUB":return 4;default:return 3}}async prepareTFService(e,t){const r=await this.dataService.getAllCompletedPredictions(t,e.pair);if(r&&r.length){const e=r.map(e=>({predRate:e.predRate,realRate:e.realRate,finalRate:e.finalRate,forecast:e.forecast,volatility:e.volatility}));return this.tfsService=void 0,this.tfsService=new m(e),await this.tfsService.trainModel(500,32)}return"empty"}getComputedPrediction(e){return this.tfsService.getResult([this.getVolatilityByPair(e.volatility,e.pair),e.forecast,e.realRate,e.predRate],500)}}(new class{constructor(){D(this,"config",{schema:[S],deleteRealmIfMigrationNeeded:!0,path:"./db/files/predictions/01.realm"})}getAll(e){return P.a.open(this.config).then(t=>t.objects("Prediction").filtered(`owner = "${e}"`).sorted("time",!0)).catch(e=>{g.error(e.message)})}storeSingle(e){P.a.open(this.config).then(t=>{t.write(()=>{t.create("Prediction",j(j({},e),{},{finalRate:0,verifyTime:0,id:Date.now()}),P.a.UpdateMode.Never)}),t.close()}).catch(e=>g.error(e.message))}getAllCompletedPredictions(e,t){return P.a.open(this.config).then(r=>r.objects("Prediction").filtered(`owner = "${e}" AND finalRate != 0 AND pair = "${t}"`)).catch(e=>{g.error(e.message)})}}),L=new d.a;var G=()=>(L.post(($.post("/",E,async(e,t)=>{try{I.storeSingle(H(H({},e.request.body),{},{owner:F(e)})),e.body={message:"Done!"}}catch(t){e.body={message:t.message}}await t()}),$.middleware())),L.post(($.post("/compute-current",E,async(e,t)=>{try{const t=await I.getComputedPrediction(e.request.body);e.body={message:"Done!",result:t}}catch(t){e.body={message:t.message}}await t()}),$.middleware())),L.post(($.post("/prepare-for-history",E,async(e,t)=>{try{const t=await I.prepareTFService(e.request.body,F(e));e.body={message:"Done!",status:t}}catch(t){e.body={message:t.message}}await t()}),$.middleware())),L.get(($.get("/",E,async(e,t)=>{try{const t=await I.getAll(F(e));e.body={message:"Done fetch!",predictions:Object(_.map)(Object(_.dissoc)("owner"),t)}}catch(t){e.body={message:t.message}}await t()}),$.middleware())),L.middleware());function V(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class z{static set(e,t){this.latestBase=e,this.latestRates=t}static ratesHaveValue(){return!!this.latestRates&&!!Object.keys(this.latestRates).length}static isRequiredTimePassed(){return Date.now()-this.prevSet>this.requiredMsGap}static updatePrevRequestTime(){this.prevSet=Date.now()}static isNewValue(e,t){return this.latestBase!==e||this.latestRates.USDEUR.toString()!==t.USDEUR.toString()||this.latestRates.USDNOK.toString()!==t.USDNOK.toString()||this.latestRates.USDGBP.toString()!==t.USDGBP.toString()||this.latestRates.USDRUB.toString()!==t.USDRUB.toString()||this.latestRates.USDCHF.toString()!==t.USDCHF.toString()||this.latestRates.USDPLN.toString()!==t.USDPLN.toString()}}function J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}V(z,"prevSet",Date.now()),V(z,"requiredMsGap",27e5),V(z,"latestBase",null),V(z,"latestRates",{USDEUR:0,USDNOK:0,USDGBP:0,USDRUB:0,USDCHF:0,USDPLN:0});const X=r(11).default,W=r(6);class Y{static start(e){this.job=this.instance.scheduleJob("*/45 * * * *",()=>this.requestData(e)),this.status=1}static stop(){this.instance.cancelJob(this.job),this.status=0}static dataFetched(e,t){}static requestData(e){z.isRequiredTimePassed()&&(z.updatePrevRequestTime(),console.log((new Date).toLocaleTimeString()),X.get(this.endpoint+"&currency=USDEUR,USDPLN,USDNOK,USDGBP,USDCHF,USDRUB").then(t=>this.dataFetched(e,t.data)).catch(console.error))}}J(Y,"endpoint","https://fxmarketapi.com/apilive?api_key=WtgXjLLRpYZqNwOOXId0"),J(Y,"instance",W),J(Y,"job",null),J(Y,"status",0);const Z={name:"Rate",primaryKey:"id",properties:{id:"int",base:{type:"string",indexed:!0},USD:"double",EUR:"double",NOK:"double",GBP:"double",RUB:"double",CHF:"double",PLN:"double",time:"string"}};function Q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const ee=new(r(1)),te=new class{constructor(e){var t,r,s;s=void 0,(r="dataService")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.dataService=e,this.bindSchedulerService(),this.enable()}bindSchedulerService(){Y.dataFetched=this.dataFetched.bind(this)}enable(){Y.start("USD"),Y.requestData("USD")}getStatus(){return Y.status}dataFetched(e,t){this.isSaveAllowed(e,t.price||{})&&this.dataService.storeSingle(e,t.price||{}),this.updateStaticStore(e,t.price||{})}updateStaticStore(e,t){z.set(e,t)}isSaveAllowed(e,t){return z.isNewValue(e,t)}}(new class{constructor(){Q(this,"validCurrencies",["USD","EUR","NOK","GBP","RUB","CHF","PLN"]),Q(this,"config",{schema:[Z],deleteRealmIfMigrationNeeded:!0,path:"./db/files/rates/01.realm"})}storeSingle(e,t){P.a.open(this.config).then(r=>{r.write(()=>{r.create("Rate",{id:Date.now(),base:e,USD:1,EUR:parseFloat(t.USDEUR),NOK:parseFloat(t.USDNOK),GBP:parseFloat(t.USDGBP),RUB:parseFloat(t.USDRUB),CHF:parseFloat(t.USDCHF),PLN:parseFloat(t.USDPLN),time:(new Date).toISOString()},P.a.UpdateMode.Never)}),r.close()}).catch(e=>{g.error(e.message)})}}),re=new d.a;var se=()=>(re.post((ee.post("/enable",E,async(e,t)=>{try{te.enable(),e.body={message:"Done",status:await te.getStatus()}}catch(t){e.body={message:t.message}}await t()}),ee.middleware())),re.get((ee.get("/status",E,async(e,t)=>{try{const t=await te.getStatus();e.body={message:"Done",status:t}}catch(t){e.body={message:t.message}}await t()}),ee.middleware())),re.middleware());function ae(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const ie=r(6);class ne{static start(e){this.job=this.instance.scheduleJob("*/30 * * * * *",()=>this.startPendingItemsReview(e)),this.status=1}static stop(){this.instance.cancelJob(this.job),this.status=0}static startPendingItemsReview(e){}}ae(ne,"instance",ie),ae(ne,"job",null),ae(ne,"status",0);const oe=new(r(1)),ce=new class{constructor(e){var t,r,s;s=void 0,(r="dataService")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.dataService=e,this.bindSchedulerService(),this.enable()}enable(){ne.start("USD")}getStatus(){return ne.status}bindSchedulerService(){ne.startPendingItemsReview=this.fillPendingPredictions.bind(this)}fillPendingPredictions(){z.ratesHaveValue()&&this.dataService.fillPendingPredictions(z.latestRates)}}(new class{constructor(){var e,t,r;r={schema:[S],deleteRealmIfMigrationNeeded:!0,path:"./db/files/predictions/01.realm"},(t="config")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}fillPendingPredictions(e){return P.a.open(this.config).then(t=>{const r=Date.now(),s=t.objects("Prediction").filtered("finalRate = 0 AND time < "+r)||[];t.write(()=>{s.forEach(t=>{const[s,a]=t.pair.split("/");t.finalRate=parseFloat(e[a]),t.verifyTime=r})}),t.close()}).catch(e=>{g.error(e.message)})}}),le=new d.a;var de=()=>(le.post((oe.post("/enable",E,async(e,t)=>{try{ce.enable(),e.body={message:"Done",status:await ce.getStatus()}}catch(t){e.body={message:t.message}}await t()}),oe.middleware())),le.get((oe.get("/status",E,async(e,t)=>{try{const t=await ce.getStatus();e.body={message:"Done",status:t}}catch(t){e.body={message:t.message}}await t()}),oe.middleware())),le.middleware());function ue(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const pe=new(r(1)),ge=new class{constructor(e){var t,r,s;s=void 0,(r="dataService")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.dataService=e}getPair(e,t){return this.dataService.getPair(e)}getHistory(e,t){return this.dataService.getHistory(e,t)}}(new class{constructor(){ue(this,"validCurrencies",["USD","EUR","NOK","GBP","RUB","CHF","PLN"]),ue(this,"config",{schema:[Z],deleteRealmIfMigrationNeeded:!0,path:"./db/files/rates/01.realm"})}getPair(e){return P.a.open(this.config).then(t=>t.objects("Rate").filtered(`base = "${e}"`).sorted("id",!0).slice(0,1)).catch(e=>{g.error(e.message)})}getHistory(e,t){return P.a.open(this.config).then(r=>r.objects("Rate").filtered(`base = "${e}"`).slice(0,t)).catch(e=>{g.error(e.message)})}}),be=new d.a;var he=()=>(be.get((pe.get("/pair",E,async(e,t)=>{try{const{base:t,second:r}=e.request.query,s=await ge.getPair(t,r);e.body={message:"Done",rates:s}}catch(t){e.body={message:t.message}}await t()}),pe.middleware())),be.get((pe.get("/history",E,async(e,t)=>{try{const{base:t,limit:r}=e.request.query,s=await ge.getHistory(t,r);e.body={message:"Done",rates:s}}catch(t){e.body={message:t.message}}await t()}),pe.middleware())),be.middleware());const me=r(12);class fe{static sendPwReset(e,t){return this.emailTransporter.sendMail({from:'"Rates pal" <noreply@ratespal.com>',to:e,subject:"Reset password",text:"",html:t})}}var ye,we,Se;ye=fe,we="emailTransporter",Se=me.createTransport({host:"smtp.gmail.com",port:465,service:"gmail",secure:!1,auth:{user:"ratespalmail@gmail.com",pass:"rer9Ohdgmail"},debug:!1,logger:!0}),we in ye?Object.defineProperty(ye,we,{value:Se,enumerable:!0,configurable:!0,writable:!0}):ye[we]=Se;const ve=new(r(1)),Pe=new class{constructor(e){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"dataService",void 0),this.dataService=e}register(e){return this.dataService.registerUser(e)}getUser(e){return this.dataService.getUser(e)}storeSession(e,t){return this.dataService.storeSession(e,t)}destroySession(e){return this.dataService.destroySession(e)}async initRestore(e){const t=await this.dataService.getRestoreToken(e);var r,s;return t.data.token&&fe.sendPwReset(e,(r=t.data.name,s=t.data.token,`\n        Hi ${r}, <br>\n        Need to reset your password? Click on the link below to get you in.  <br>\n        <a href="http://localhost:4000/reset-password?v=${s}">Create new password</a>\n    `)),t}createPw(e,t){return this.dataService.createPw(e,t)}}(new M),Oe=async(e,t)=>{e.type="json",e.set("Access-Control-Expose-Headers","GoAway"),await t()},je=new d.a;var De=()=>(je.post((ve.post("/register",Oe,async(e,t)=>{try{const t=await Pe.register(e.request.body);e.status=t.code,e.body={message:"Done",resp:t}}catch(t){e.status=500,e.body={message:t.message}}await t()}),ve.middleware())),je.post((ve.post("/login",Oe,async(e,t)=>{try{const t=await Pe.getUser(e.request.body);t.data?(Pe.storeSession(t.data.hashedEmail,e.request.headers.referer),e.session.user=`${t.data.hashedEmail}$${Date.now()}`,e.body={message:"Done",data:{email:t.data.email,name:t.data.name}}):e.body={message:"Not found",data:{}},e.status=t.code}catch(t){e.status=500,e.body={message:t.message}}await t()}),ve.middleware())),je.post((ve.post("/logout",Oe,async(e,t)=>{try{Pe.destroySession(F(e)),e.status=200,e.body={message:"Done"}}catch(t){e.status=500,e.body={message:t.message}}await t()}),ve.middleware())),je.post((ve.post("/restore",Oe,async(e,t)=>{try{const t=await Pe.initRestore(e.request.body.user);e.status=t.code,e.body={message:"Done"}}catch(t){e.status=500,e.body={message:t.message}}await t()}),ve.middleware())),je.post((ve.post("/create-pw",Oe,async(e,t)=>{try{const t=await Pe.createPw(e.request.body.pw,e.request.body.v);e.status=t.code,e.body={message:"Done",data:t}}catch(t){e.status=500,e.body={message:t.message}}await t()}),ve.middleware())),je.middleware());function Re(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ue=new(r(1)),qe=new class{constructor(e,t){Re(this,"tfsService",void 0),Re(this,"dataService",void 0),this.dataService=e,this.tfsService=t}getAllCompletedPredictions(e,t){return this.dataService.getAllCompletedPredictions(e,t)}}(new class{constructor(){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"config",{schema:[S],deleteRealmIfMigrationNeeded:!0,path:"./db/files/predictions/01.realm"})}getAllCompletedPredictions(e,t){return P.a.open(this.config).then(r=>r.objects("Prediction").filtered(`owner = "${e}" AND finalRate != 0 AND time >= ${t.dateStart} AND time <= ${t.dateEnd}`).sorted("time",!0)).catch(e=>{g.error(e.message)})}},new m),Ne=new d.a;var Te=()=>(Ne.post((Ue.post("/completed",E,async(e,t)=>{try{const t=await qe.getAllCompletedPredictions(F(e),e.request.body);e.body={message:"Done",data:Object(_.map)(Object(_.dissoc)("owner"),t)}}catch(t){e.body={message:t.message}}await t()}),Ue.middleware())),Ne.middleware());const xe=new d.a;r(13);const Ce=r(2),ke=r(14),Me={useToken:!0,useCookie:!1,key:"GoAway",maxAge:864e5,autoCommit:!0,overwrite:!0,httpOnly:!0,signed:!0,rolling:!1,renew:!1,genid:e=>g.warn(e)};const Fe=new(r(15)),Be=process.env.HOST||"127.0.0.1",Ee=process.env.PORT||s.port;var _e;(_e=Fe).use(async(e,t)=>{try{await t(),404===e.status&&e.throw(404),401===e.status&&e.throw(401),200===e.status&&(e.body={status:200,data:e.body})}catch(t){g.error(t),e.status=t.status||500,e.type="json",e.body={status:e.status,message:t.message},e.app.emit("error",t,e)}}),_e.keys=["11223344qqwweerr"],_e.use(c()()),_e.use(n()(a.root)),_e.use(ke(Me,_e)),_e.use(Ce("/api",(xe.use(p()("/predictions",G())),xe.use(p()("/rates-scheduler",se())),xe.use(p()("/predictions-scheduler",de())),xe.use(p()("/rates",he())),xe.use(p()("/users",De())),xe.use(p()("/analyze",Te())),xe.middleware()))),_e.on("error",e=>{g.error(e.message)}),Fe.listen(Ee,Be)}]);
//# sourceMappingURL=main.map